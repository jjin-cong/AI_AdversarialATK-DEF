{"cells":[{"cell_type":"markdown","metadata":{"id":"AYV_dMVDxyc2","pycharm":{"name":"#%% md\n"}},"source":["[![Github](https://img.shields.io/github/stars/labmlai/annotated_deep_learning_paper_implementations?style=social)](https://github.com/labmlai/annotated_deep_learning_paper_implementations)\n","[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/labmlai/annotated_deep_learning_paper_implementations/blob/master/labml_nn/diffusion/ddpm/experiment.ipynb)\n","[![Open In Comet](https://images.labml.ai/images/comet.svg?experiment=capsule_networks&file=model)](https://www.comet.com/labml/diffuse/view/FknjSiKWotr8fgZerpC1sV1cy/panels?utm_source=referral&utm_medium=partner&utm_campaign=labml)\n","\n","## [Denoising Diffusion Probabilistic Models (DDPM)](https://nn.labml.ai/diffusion/ddpm/index.html)\n","\n","This notebook trains a DDPM based model on MNIST digits dataset."]},{"cell_type":"markdown","metadata":{"id":"AahG_i2y5tY9","pycharm":{"name":"#%% md\n"}},"source":["### Install the packages"]},{"cell_type":"code","execution_count":1,"metadata":{"id":"ZCzmCrAIVg0L","pycharm":{"name":"#%%\n"},"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1659068293575,"user_tz":-540,"elapsed":16474,"user":{"displayName":"김채현","userId":"06024775478798789360"}},"outputId":"b4f2a991-62a5-4fa2-bdd3-a15b98633e8b"},"outputs":[{"output_type":"stream","name":"stdout","text":["\u001b[K     |████████████████████████████████| 357 kB 28.9 MB/s \n","\u001b[K     |████████████████████████████████| 373 kB 69.2 MB/s \n","\u001b[K     |████████████████████████████████| 128 kB 75.3 MB/s \n","\u001b[K     |████████████████████████████████| 181 kB 64.9 MB/s \n","\u001b[K     |████████████████████████████████| 156 kB 53.6 MB/s \n","\u001b[K     |████████████████████████████████| 54 kB 3.2 MB/s \n","\u001b[K     |████████████████████████████████| 510 kB 63.2 MB/s \n","\u001b[K     |████████████████████████████████| 54 kB 2.9 MB/s \n","\u001b[K     |████████████████████████████████| 63 kB 1.7 MB/s \n","\u001b[?25h  Building wheel for nvidia-ml-py3 (setup.py) ... \u001b[?25l\u001b[?25hdone\n","  Building wheel for configobj (setup.py) ... \u001b[?25l\u001b[?25hdone\n"]}],"source":["!pip install labml-nn comet_ml --quiet"]},{"cell_type":"markdown","metadata":{"pycharm":{"name":"#%% md\n"},"id":"iw4MDTf4rQJE"},"source":["### Enable [Comet](https://www.comet.ml)"]},{"cell_type":"code","execution_count":2,"metadata":{"pycharm":{"name":"#%%\n"},"id":"SOq2RgcFrQJF","executionInfo":{"status":"ok","timestamp":1659068300861,"user_tz":-540,"elapsed":7312,"user":{"displayName":"김채현","userId":"06024775478798789360"}},"colab":{"base_uri":"https://localhost:8080/"},"outputId":"9bf0a2ca-e887-4285-c363-fcdcc6eb28d9"},"outputs":[{"name":"stdout","output_type":"stream","text":["Please enter your Comet API key from https://www.comet-ml.com/api/my/settings/\n","(api key may not show as you type)\n","Comet API key: ··········\n"]},{"output_type":"stream","name":"stderr","text":["COMET INFO: Comet API key is valid\n","COMET WARNING: running in Google Colab, but can't find mounted drive. Using HOME instead\n","COMET WARNING: if drive is mounted, set COMET_CONFIG to save config there\n","COMET INFO: Comet API key saved in /root/.comet.config\n"]}],"source":["#@markdown Select in order to enable logging this experiment to [Comet](https://www.comet.ml).\n","use_comet = True #@param {type:\"boolean\"}\n","\n","if use_comet:\n","    import comet_ml\n","    comet_ml.init(project_name='diffusion')"]},{"cell_type":"markdown","metadata":{"id":"SE2VUQ6L5zxI","pycharm":{"name":"#%% md\n"}},"source":["### Imports"]},{"cell_type":"code","execution_count":3,"metadata":{"jupyter":{"outputs_hidden":false},"pycharm":{"name":"#%%\n"},"id":"_DuTmzQmrQJF","executionInfo":{"status":"ok","timestamp":1659068304392,"user_tz":-540,"elapsed":3536,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":["import torch\n","import torch.nn as nn\n","\n","from labml import experiment\n","from labml.configs import option\n","from labml_nn.diffusion.ddpm.experiment import Configs"]},{"cell_type":"markdown","metadata":{"pycharm":{"name":"#%% md\n"},"id":"nqSdJj8YrQJF"},"source":["### Create an experiment"]},{"cell_type":"code","execution_count":4,"metadata":{"jupyter":{"outputs_hidden":false},"pycharm":{"name":"#%%\n"},"id":"cJSq2qXsrQJF","executionInfo":{"status":"ok","timestamp":1659068304393,"user_tz":-540,"elapsed":17,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":["experiment.create(name=\"diffuse\", writers={\"screen\", \"comet\"} if use_comet else {'screen'})"]},{"cell_type":"markdown","metadata":{"pycharm":{"name":"#%% md\n"},"id":"Sk7kSpjprQJG"},"source":["### Configurations"]},{"cell_type":"code","execution_count":5,"metadata":{"jupyter":{"outputs_hidden":false},"pycharm":{"name":"#%%\n"},"id":"2LQXyOPArQJG","executionInfo":{"status":"ok","timestamp":1659068304393,"user_tz":-540,"elapsed":13,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":["configs = Configs()"]},{"cell_type":"markdown","metadata":{"pycharm":{"name":"#%% md\n"},"id":"BZFZft8erQJG"},"source":["Set experiment configurations and assign a configurations dictionary to override configurations"]},{"cell_type":"code","execution_count":6,"metadata":{"jupyter":{"outputs_hidden":false},"pycharm":{"name":"#%%\n"},"id":"vE5WQeJhrQJG","colab":{"base_uri":"https://localhost:8080/","height":17},"executionInfo":{"status":"ok","timestamp":1659068304394,"user_tz":-540,"elapsed":12,"user":{"displayName":"김채현","userId":"06024775478798789360"}},"outputId":"491d3e0f-9a7c-45d8-d133-773e81d21aa6"},"outputs":[{"output_type":"display_data","data":{"text/plain":["<IPython.core.display.HTML object>"],"text/html":["<pre style=\"overflow-x: scroll;\"></pre>"]},"metadata":{}}],"source":["experiment.configs(configs, {\n","    'dataset': 'CelebA',\n","    'image_channels': 3,\n","    'epochs': 100,\n","})"]},{"cell_type":"markdown","metadata":{"pycharm":{"name":"#%% md\n"},"id":"KOfmw3nZrQJG"},"source":["Initializ"]},{"cell_type":"code","execution_count":7,"metadata":{"pycharm":{"name":"#%%\n"},"id":"2F8gX6K7rQJH","colab":{"base_uri":"https://localhost:8080/","height":494},"executionInfo":{"status":"error","timestamp":1659068310088,"user_tz":-540,"elapsed":5703,"user":{"displayName":"김채현","userId":"06024775478798789360"}},"outputId":"cbfc0bc4-e026-475b-f4f9-42cf6579499d"},"outputs":[{"output_type":"display_data","data":{"text/plain":["<IPython.core.display.HTML object>"],"text/html":["<pre style=\"overflow-x: scroll;\">Prepare device.device...\n","  Prepare device.device_info<span style=\"color: #00A250\">...[DONE]</span><span style=\"color: #208FFB\">\t9.68ms</span>\n","Prepare device.device<span style=\"color: #00A250\">...[DONE]</span><span style=\"color: #208FFB\">\t16.43ms</span>\n","Prepare dataset<span style=\"color: #00A250\">...[DONE]</span><span style=\"color: #208FFB\">\t5.96ms</span>\n","</pre>"]},"metadata":{}},{"output_type":"error","ename":"ValueError","evalue":"ignored","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mValueError\u001b[0m                                Traceback (most recent call last)","\u001b[0;32m<ipython-input-7-eed6c5793f23>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[0;32m----> 1\u001b[0;31m \u001b[0mconfigs\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0minit\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/labml_nn/diffusion/ddpm/experiment.py\u001b[0m in \u001b[0;36minit\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m     96\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     97\u001b[0m         \u001b[0;31m# Create dataloader\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 98\u001b[0;31m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdata_loader\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mtorch\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mutils\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdata\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mDataLoader\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mdataset\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mbatch_size\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mshuffle\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mTrue\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mpin_memory\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;32mTrue\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     99\u001b[0m         \u001b[0;31m# Create optimizer\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    100\u001b[0m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0moptimizer\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mtorch\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0moptim\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mAdam\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0meps_model\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mparameters\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mlr\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mlearning_rate\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/torch/utils/data/dataloader.py\u001b[0m in \u001b[0;36m__init__\u001b[0;34m(self, dataset, batch_size, shuffle, sampler, batch_sampler, num_workers, collate_fn, pin_memory, drop_last, timeout, worker_init_fn, multiprocessing_context, generator, prefetch_factor, persistent_workers, pin_memory_device)\u001b[0m\n\u001b[1;32m    345\u001b[0m             \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m  \u001b[0;31m# map-style\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    346\u001b[0m                 \u001b[0;32mif\u001b[0m \u001b[0mshuffle\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 347\u001b[0;31m                     \u001b[0msampler\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mRandomSampler\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mdataset\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mgenerator\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0mgenerator\u001b[0m\u001b[0;34m)\u001b[0m  \u001b[0;31m# type: ignore[arg-type]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    348\u001b[0m                 \u001b[0;32melse\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    349\u001b[0m                     \u001b[0msampler\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mSequentialSampler\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mdataset\u001b[0m\u001b[0;34m)\u001b[0m  \u001b[0;31m# type: ignore[arg-type]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.7/dist-packages/torch/utils/data/sampler.py\u001b[0m in \u001b[0;36m__init__\u001b[0;34m(self, data_source, replacement, num_samples, generator)\u001b[0m\n\u001b[1;32m    106\u001b[0m         \u001b[0;32mif\u001b[0m \u001b[0;32mnot\u001b[0m \u001b[0misinstance\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mnum_samples\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mint\u001b[0m\u001b[0;34m)\u001b[0m \u001b[0;32mor\u001b[0m \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mnum_samples\u001b[0m \u001b[0;34m<=\u001b[0m \u001b[0;36m0\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    107\u001b[0m             raise ValueError(\"num_samples should be a positive integer \"\n\u001b[0;32m--> 108\u001b[0;31m                              \"value, but got num_samples={}\".format(self.num_samples))\n\u001b[0m\u001b[1;32m    109\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    110\u001b[0m     \u001b[0;34m@\u001b[0m\u001b[0mproperty\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;31mValueError\u001b[0m: num_samples should be a positive integer value, but got num_samples=0"]}],"source":["configs.init()"]},{"cell_type":"markdown","metadata":{"id":"EvI7MtgJ61w5","pycharm":{"name":"#%% md\n"}},"source":["Set PyTorch models for loading and saving"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"GDlt7dp-5ALt","pycharm":{"name":"#%%\n"},"executionInfo":{"status":"aborted","timestamp":1659068310085,"user_tz":-540,"elapsed":688,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":["experiment.add_pytorch_models({'eps_model': configs.eps_model})"]},{"cell_type":"markdown","metadata":{"id":"KJZRf8527GxL","pycharm":{"name":"#%% md\n"}},"source":["### Start the experiment and run the training loop."]},{"cell_type":"code","execution_count":null,"metadata":{"id":"aIAWo7Fw5DR8","pycharm":{"name":"#%%\n"},"executionInfo":{"status":"aborted","timestamp":1659068310086,"user_tz":-540,"elapsed":688,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":["# Start the experiment\n","with experiment.start():\n","    configs.run()"]},{"cell_type":"code","execution_count":null,"metadata":{"pycharm":{"name":"#%%\n"},"id":"2jDK9o_IrQJH","executionInfo":{"status":"aborted","timestamp":1659068310087,"user_tz":-540,"elapsed":10,"user":{"displayName":"김채현","userId":"06024775478798789360"}}},"outputs":[],"source":[""]}],"metadata":{"accelerator":"GPU","colab":{"collapsed_sections":[],"name":"[ref] DDPM_CelebA","provenance":[{"file_id":"https://github.com/labmlai/annotated_deep_learning_paper_implementations/blob/master/labml_nn/diffusion/ddpm/experiment.ipynb","timestamp":1659026395076}]},"kernelspec":{"display_name":"Python 3 (ipykernel)","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.8.12"},"gpuClass":"standard"},"nbformat":4,"nbformat_minor":0}